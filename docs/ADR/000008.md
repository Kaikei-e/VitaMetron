# Condition 7-day Trend の limit パラメータ削除

## ADR's STATUS

採用済み (2026-02-24)

## CONTEXT

ダッシュボードの「現在」タブにある Well-being 7-day Trend チャートが、当日（2月24日）にもかかわらず2月21日までしか表示されない不具合が発生していた。

### データフロー

1. ダッシュボード SSR が以下のリクエストを送信:
   ```
   /api/conditions?from=2026-02-17&to=2026-02-24&limit=7&sort=logged_at&order=asc
   ```

2. Go API がクエリを実行し、`logged_at ASC`（古い順）でソートした上で `LIMIT 7` で最初の7件のみ返却

3. `TrendChart.svelte` は各 ConditionLog を1つのデータポイントとしてプロット

### 問題の原因

Condition は1日に複数回記録できる。7日間に合計7件以上のログが存在する場合、`limit=7` により新しい日付のログが切り捨てられる。

例: 2月18日に2回ログを記録すると、それだけで2件を消費し、結果として最新の数日分が表示されなくなる。

## DECISION MAKING

### 検討した選択肢

| 選択肢 | 概要 | 評価 |
|---|---|---|
| A. `limit` を削除 | `from` / `to` の日付範囲で十分に絞り込まれているため、`limit` を除去 | ✅ 採用 |
| B. `limit` を大きな値に変更 | `limit=100` 等に引き上げて対処 | △ 根本解決にならず、上限に達すれば同じ問題が再発 |
| C. 日ごとに集約して返す API を新設 | 日別に最新ログまたは平均値を返す専用エンドポイントを作成 | △ 過剰対応、別の改善課題として切り出すべき |

### 選択肢 A を採用した理由

- **シンプルさ**: `from` と `to` による日付範囲クエリで既に十分な絞り込みがされており、`limit` は冗長
- **根本原因の解消**: 1日複数ログの状況で件数が足りなくなる問題を完全に排除
- **影響範囲の最小化**: フロントエンドの1行変更のみで修正可能

## RESULTS, EFFECTS

### PROS

- **7-day Trend が常に直近7日間全体を表示**: 1日に何件ログがあっても最新日まで確実に表示される
- **変更量が最小限**: クエリパラメータの削除のみで、API 側の変更は不要

### CONS, TRADEOFF

- **返却件数の上限がなくなる**: 7日間に大量のログがあった場合、全件がフロントエンドに渡される。ただし単一ユーザーシステムで7日間のログ数は実用上問題にならない
- **x軸の重複表示は未解決**: 同一日に複数ログがある場合、チャートのx軸に同じ日付が繰り返し表示される。これは別の改善課題（日別集約の導入）として今後対応を検討する

## APPENDIX

### 変更ファイル

| ファイル | 変更内容 |
|---|---|
| `frontend/src/lib/server/services/dashboard.ts` | `recentConditions` クエリから `limit=7` パラメータを削除 |
