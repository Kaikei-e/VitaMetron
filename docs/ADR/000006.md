# 深夜帯ダッシュボードの "Effective Date" 導入 (Overnight Mode)

## ADR's STATUS

採用済み (2026-02-20)

## CONTEXT

日付が 0:00 に変わると、ダッシュボードの日付計算関数 `todayISO()` が新しい日付を返すため、全 API コールが空データの新日付でフェッチされる。深夜 0:00〜5:59 の間、以下の問題が発生していた:

- **VRI Score**: 空データに基づく低信頼度スコア（例: 5, Confidence 30%）を表示
- **今日の一言 (AI アドバイス)**: 空データに基づく無意味なアドバイスを LLM が生成
- **バイオメトリクスタイル**: 全メトリクスが 0 / `--` を表示
- **Today's Condition**: 前日のデータを "Today's" ラベルで表示（日付不一致）

ヘルスケアアプリでは「1日の開始」を起床時刻または早朝の固定時刻とするのが一般的なプラクティスである（例: Oura Ring は 18:00–18:00 ウィンドウで睡眠を管理、Fitbit は起床後に Readiness Score を算出）。

## DECISION MAKING

### 検討した選択肢

| 選択肢 | 概要 | 評価 |
|---|---|---|
| A. バックエンド API に "effective date" ロジックを導入 | Go API 側で深夜帯の日付シフトを行い、レスポンスに反映 | △ 全エンドポイントの変更が必要、他クライアントへの影響 |
| B. フロントエンドの日付計算を丸ごと置換 | 既存の `todayISO()` 自体を深夜帯対応に変更 | △ ConditionForm 等のカレンダー日付ロジックが壊れる（深夜3時に「今日」の体調を記録したい場合） |
| C. フロントエンドに "effective date" 関数群を追加 | 既存関数を維持したまま、ダッシュボード用の `effectiveDateISO()` / `effectiveDaysAgoISO()` を新設 | ✅ 採用 |

### 選択肢 C を採用した理由

- **バックエンド変更不要**: フロントエンドが API に渡す日付パラメータが変わるだけで、Go API・ML サービスは一切変更なし
- **既存ロジックへの影響なし**: `todayISO()` / `daysAgoISO()` はそのまま残り、ConditionForm 等のカレンダー日付入力は従来通り動作
- **変更の局所性**: フロントエンドの日付ユーティリティ + SSR サービス層 + 一部コンポーネントのみの修正で完結
- **タイムゾーンの一貫性**: 全 Docker サービスに `TZ: Asia/Tokyo` が設定済みのため、SSR 環境でも `new Date().getHours()` が JST を返す

### 設計詳細

**境界時刻**: 6:00 AM (JST)

- 0:00〜5:59 → `effectiveDateISO()` は前日を返す（overnight mode）
- 6:00〜23:59 → `effectiveDateISO()` は当日を返す（通常モード）

```typescript
export const DAY_START_HOUR = 6;

export function isOvernightHours(): boolean {
  return new Date().getHours() < DAY_START_HOUR;
}

export function effectiveDateISO(): string {
  return isOvernightHours() ? daysAgoISO(1) : todayISO();
}

export function effectiveDaysAgoISO(n: number): string {
  return daysAgoISO(isOvernightHours() ? n + 1 : n);
}
```

**UI フィードバック**: 深夜帯にはダッシュボード上部に indigo カラーのバナーを表示し、ユーザーに昨日のサマリーを表示中であることを伝える。

## RESULTS, EFFECTS

### PROS

- **深夜帯のデータ表示が実用的になる**: 0:00 に日付が変わっても、前日のデータが完全な状態で表示される
- **AI アドバイスの無駄な再生成を回避**: effective date = 前日のため、キャッシュ済みアドバイスが返る（LLM 呼び出しなし）
- **ConditionCard のラベルが正確**: effective date とデータの日付を比較し、"Today's Condition" / "Latest Condition" を動的に切り替え
- **バックエンド無変更**: フロントエンドのみの変更で完結し、API の契約に影響なし
- **型チェック通過**: `svelte-check` で 0 errors / 0 warnings を確認済み

### CONS, TRADEOFF

- **6:00 AM 境界の硬直性**: `DAY_START_HOUR` は定数であり、ユーザーの実際の起床時刻と一致しない場合がある。将来的にユーザー設定で変更可能にする余地はある
- **SSR キャッシュとの相互作用**: 現状 SvelteKit SSR にキャッシュ設定はないため問題ないが、将来 CDN キャッシュ等を導入する場合は 6:00 AM 境界を `Cache-Control` で考慮する必要がある
- **ConditionForm との非対称性**: ダッシュボードは effective date を使うが、ConditionForm はカレンダー日付を使う。深夜3時にフォームで「今日」を選ぶと新日付で記録されるため、ダッシュボードの effective date とは1日ずれる（意図的な設計）

## APPENDIX

### 変更ファイル一覧

| ファイル | 変更内容 |
|---|---|
| `frontend/src/lib/utils/date.ts` | `DAY_START_HOUR`, `isOvernightHours()`, `effectiveDateISO()`, `effectiveDaysAgoISO()` を追加 |
| `frontend/src/lib/server/services/dashboard.ts` | `todayISO()` → `effectiveDateISO()` に置換、`DashboardData` に `isOvernightMode` / `effectiveDate` を追加 |
| `frontend/src/routes/+page.svelte` | 深夜モードバナー追加、`ConditionCard` / `DailyAdviceCard` に `effectiveDate` prop を追加 |
| `frontend/src/lib/components/dashboard/ConditionCard.svelte` | `effectiveDate` prop を受け取り、タイトルを動的に "Today's" / "Latest" 切り替え |
| `frontend/src/lib/components/dashboard/DailyAdviceCard.svelte` | `effectiveDate` prop を受け取り、再生成時に effective date を使用 |
| `frontend/src/lib/server/services/insights.ts` | `todayISO()` / `daysAgoISO()` → effective date 関数に置換 |
| `frontend/src/lib/server/services/conditions.ts` | `todayISO()` / `daysAgoISO()` → effective date 関数に置換 |

### 変更不要と判断したファイル

| ファイル | 理由 |
|---|---|
| `frontend/src/lib/components/condition/ConditionForm.svelte` | フォームの日付入力は常にカレンダー日付を使うべき（深夜でも「今日」の体調を記録する用途） |
| バックエンド API (Go) | 変更不要 — フロントエンドが渡す日付パラメータが変わるだけ |
| ML サービス (Python) | 変更不要 — 同上 |
| `VRICard.svelte` / `MetricTile.svelte` | props 経由でデータを受け取るだけのため変更不要 |
