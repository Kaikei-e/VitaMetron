# Daily Advice 生成タイムアウトの原因調査と Nginx タイムアウト追加

## ADR's STATUS

採用済み (2026-02-25)

## CONTEXT

ダッシュボードの「今日の一言」(Daily Advice) が 500 エラーで生成に失敗するようになった。以前は約 10 秒で完了していた LLM 生成が 67 秒に劣化し、Nginx のデフォルトタイムアウト (60 秒) を超過したことが直接の原因。

### 障害の構造

2 つの問題が同時に発生した複合障害:

1. **Ollama コンテナの GPU 認識喪失** (主因): GPU オフロードが効かなくなり、CPU フォールバックで生成時間が約 7 倍に増加
2. **Nginx タイムアウト設定の漏れ** (副因): CPU フォールバック時の応答時間が 60 秒を超え、Nginx が接続を切断

### 生成時間の推移

| 期間 | 生成時間 | 推論デバイス |
|---|---|---|
| 通常時 | 7〜10 秒 | GPU (全レイヤーオフロード) |
| 障害発生後 | 67 秒 | CPU (オフロード 0 レイヤー) |

### Nginx タイムアウトの状況

他の長時間エンドポイント (import, train) には個別の `proxy_read_timeout` が設定済みだったが、`/api/advice` は汎用ブロック (`/api/`) にフォールバックしており、デフォルトの 60 秒が適用されていた。

API ログでは `latency:"1m0.003s"` (ちょうど 60 秒) で 500 エラーが記録されており、Nginx 側のタイムアウトによる切断であることを確認。

## DECISION MAKING

### 検討した選択肢

| 選択肢 | 概要 | 評価 |
|---|---|---|
| A. Ollama 再起動 + Nginx タイムアウト追加 | GPU 復旧と再発防止の両方を対処 | ✅ 採用 |
| B. Ollama 再起動のみ | GPU が復旧すれば 60 秒以内に収まるため Nginx 変更不要 | △ GPU 喪失が再発した場合に同じ障害が起きる |
| C. API 側でタイムアウトを短縮 | Go API の ML Client タイムアウト (120 秒) を 60 秒未満に変更 | × CPU フォールバック時に生成自体ができなくなる |

### 選択肢 A を採用した理由

- **即時復旧**: Ollama コンテナの再起動で GPU デバイスマッピングが再作成され、生成時間が正常値に復帰
- **再発防止**: Nginx にタイムアウトを追加することで、仮に GPU 喪失が再発しても CPU フォールバックで生成を完了できる
- **既存パターンとの一貫性**: import / train エンドポイントと同じパターンで location ブロックを追加

### タイムアウト値の設計

```
API → ML Client タイムアウト: 120 秒
Nginx proxy_read_timeout:     150 秒 (= 120 秒 + 30 秒マージン)
```

Nginx のタイムアウトは API 側より十分大きくし、API が先にタイムアウトして適切なエラーレスポンスを返せるようにしている。

## RESULTS, EFFECTS

### PROS

- **GPU 喪失時にも LLM 生成が完了する**: CPU フォールバックで 67 秒かかっても Nginx が切断しない
- **既存のタイムアウト設計と一貫**: import (300s), train (1800s) と同様の location ブロック分離パターン
- **変更量が最小限**: `nginx.conf` に location ブロック 1 つを追加するのみ

### CONS, TRADEOFF

- **GPU 喪失の根本原因は未解決**: コンテナ再起動で復旧したが、GPU デバイスマッピングが失効する根本原因（ホスト側のドライバ更新、カーネルイベント等）は特定できていない。再発時は `docker compose restart ollama` で対処する
- **CPU フォールバック時の UX 劣化は許容**: 生成に 67 秒かかるとユーザー体験は悪いが、500 エラーで完全に失敗するよりは良い

## APPENDIX

### 変更ファイル

| ファイル | 変更内容 |
|---|---|
| `nginx/nginx.conf` | `/api/advice` 用の location ブロックを追加 (`proxy_read_timeout 150s`) |

### Nginx location ブロックの優先順位 (上から評価)

| location | timeout | 用途 |
|---|---|---|
| `/api/import/health-connect` | 300s | Health Connect インポート |
| `/api/import/healthkit` | 600s | HealthKit インポート |
| `~ ^/api/(hrv\|divergence\|anomaly)/train` | 1800s | ML モデル学習 |
| `/api/advice` | 150s | Daily Advice LLM 生成 |
| `/api/` | 60s (default) | その他 API |

### 復旧手順

```bash
# GPU 認識が失われた場合
docker compose restart ollama
# ログで GPU 復旧を確認
docker compose logs ollama | grep "inference compute"
```
