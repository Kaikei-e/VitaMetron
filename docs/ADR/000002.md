# MLモデル再トレーニングと Anomaly Train/Status API エンドポイントの追加

## ADR's STATUS

採用済み (2026-02-19)

## CONTEXT

主観データ（condition_logs）の蓄積が進み、MLモデルの再トレーニング可否を評価した。

データ蓄積状況:

| データ | 件数 | 期間 |
|---|---|---|
| condition_logs | 69件 / 64日分 | 約80日間 |
| daily_summaries | 3,516件 | 約10年間 |
| valid_days (data_quality) | 162日 | - |
| paired observations（主観+バイオ） | 61ペア | - |

3つの学習可能モデルについて再トレーニングを実施した:

| モデル | 役割 | 前回のデータ量 | 今回 |
|---|---|---|---|
| Divergence Detector | バイオメトリクスと主観体調の乖離検出 | 65ペア | 66ペア (+1) |
| HRV Predictor | HRV変動の予測 | 152日 | 152日 (再学習) |
| Anomaly Detector | バイオメトリクス異常検出 | 161日 | 162日 (+1) |

再トレーニングの過程で、Go API に `POST /anomaly/train` と `GET /anomaly/status` エンドポイントが欠落していることが判明した。ML サービス（FastAPI）側には両エンドポイントが存在していたが、Go API のプロキシ層にルーティングが実装されていなかった。HRV と Divergence には同等のエンドポイントが存在しており、Anomaly のみが不整合な状態だった。

## DECISION MAKING

### 決定1: 全3モデルの再トレーニング実施

データ増加量は小さいものの、全モデルを同時に再トレーニングした。

- **Divergence**: 主観データを直接使用する唯一のモデルであり最優先
- **HRV**: 新規データは少ないが、再学習コストが低い
- **Anomaly**: +1日分だが、他モデルと合わせて実施

### 決定2: Go API に Anomaly の train/status エンドポイントを追加

HRV・Divergence と同じパターンで実装:

1. `entity.AnomalyTrainResult` / `entity.AnomalyModelStatus` 構造体を追加
2. ML クライアントに `TrainAnomalyModel()` / `GetAnomalyStatus()` メソッドを追加
3. ハンドラーにルート登録（`POST /anomaly/train`, `GET /anomaly/status`）

既存の Nginx 設定は `location ~ ^/api/(hrv/train|divergence/train|anomaly/train)` で既に anomaly/train を含んでいたため、Nginx 側の変更は不要だった。

### 決定3: Divergence モデルの R² について

R²=0.11 は「バイオメトリクスだけで主観的体調の11%しか説明できない」ことを意味する。これは低い値だが、主観と客観の乖離検出が本来の目的であり、医学的にも妥当な範囲である。大幅な改善には以下が必要だが、今回のスコープ外とした:

- データ量の継続的な増加
- マルチ出力モデル化（mood_vas, energy_vas 等）
- 時系列特徴量の追加（直近数日のトレンド等）

## RESULTS, EFFECTS

### 再トレーニング結果

| モデル | 指標 | Before | After | 変化 |
|---|---|---|---|---|
| Divergence | R² | 0.11 | 0.11 | 同等 |
| Divergence | MAE | 18.7 | 18.4 | 微改善 |
| HRV | CV MAE | 0.63 | 0.60 | 改善 |
| HRV | CV R² | 0.32 | 0.37 | 改善 |
| HRV | 方向精度 | 83% | 82% | 微減 |
| Anomaly | 学習日数 | 161 | 162 | +1日 |

### PROS

- **API の一貫性**: 3モデルすべてに train/status エンドポイントが揃い、運用・監視が統一された
- **HRV の改善**: R² が 0.32 → 0.37、CV MAE が 0.63 → 0.60 と改善
- **モデルバージョンの更新**: 全モデルが最新データを反映したバージョンに更新された

### CONS, TRADEOFF

- **Divergence の改善は限定的**: データ量の増加が +1ペアのみであり、精度向上は微小。本質的な改善にはデータ蓄積の継続が必要
- **HRV の方向精度が微減**: 83% → 82%。CV のフォールド分割のランダム性による誤差範囲と判断

## APPENDIX

### 変更ファイル一覧

| ファイル | 変更内容 |
|---|---|
| `api/domain/entity/anomaly.go` | `AnomalyTrainResult`, `AnomalyModelStatus` 構造体を追加 |
| `api/adapter/mlclient/client.go` | `TrainAnomalyModel()`, `GetAnomalyStatus()` メソッドを追加 |
| `api/handler/anomaly.go` | `TrainAnomalyModel`, `GetAnomalyStatus` ハンドラーとルート登録を追加 |

### 新規エンドポイント

| Method | Path | 説明 |
|---|---|---|
| `POST` | `/api/anomaly/train` | Anomaly モデルの再トレーニング |
| `GET` | `/api/anomaly/status` | Anomaly モデルのステータス確認 |

