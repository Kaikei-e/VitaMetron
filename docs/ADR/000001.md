# VRI ベースライン計算におけるゼロ値センチネルのフィルタリング

## ADR's STATUS

採用済み (2026-02-19)

## CONTEXT

VRI (Vitality Recovery Index) は過去60日間のローリングベースライン（中央値/MAD）を基準に、当日のバイオメトリクスを正規化して0〜100のスコアを算出する。

一部のメトリクス（呼吸数 `br_full_sleep`、安静時心拍数 `resting_hr`、HRV `hrv_daily_rmssd`）は、ウェアラブルデバイスがデータを取得できなかった日に値 `0` を格納する。これは「測定値が0」ではなく「データなし」を意味するセンチネル値である。

既存のベースライン計算（`zscore.py` の `_extract_valid()`）は `None` のみをフィルタし、`0` を有効値として扱っていた。その結果：

1. 60日中59日が `br_full_sleep = 0` の場合、ベースラインが `median=0, MAD=0` となる
2. `MAD=0` のフォールバックにより z-score が常に `0.0` となり、メトリクスが「含まれている」のに実質無意味
3. HRV は `math.log(0) = -inf` → `isfinite()` で偶然除外されていたが、設計意図ではない

コードベース内で既にこの問題を認識している箇所が存在した：
- Go API の `plausibility.go`: `br=0`, `resting_hr=0` を missing 扱い
- ML の `anomaly_quality.py`: `ZERO_MEANS_MISSING` セットで同じメトリクスを定義
- ML の `hrv_features.py`: SQL クエリで `WHERE hrv_daily_rmssd > 0` を使用

`zscore.py` のみがこの規約に従っていなかった。

## DECISION MAKING

### 決定1: ゼロ値フィルタリングの導入箇所

**ベースライン計算と当日値スコアリングの両方**でフィルタする。

- **ベースライン側** (`_extract_valid`): `exclude_zero` パラメータを追加。ゼロをフィルタすることで中央値/MAD/カウントが実データのみから計算される
- **VRI スコアリング側** (`compute_vri`): `_ZERO_IS_MISSING_FIELDS` セットに含まれるフィールドの値が0の場合、`None`（欠損）として扱う

### 決定2: メトリクスごとの適用判断

すべてのメトリクスに一律適用せず、生理学的に0があり得ないメトリクスのみに適用：

| メトリクス | 0の意味 | フィルタ |
|---|---|---|
| `hrv_daily_rmssd` | センチネル（心拍変動がゼロは不可能） | する |
| `resting_hr` | センチネル（安静時心拍がゼロは不可能） | する |
| `br_full_sleep` | センチネル（呼吸数ゼロは不可能） | する |
| `spo2_avg` | センチネル（SpO2ゼロは不可能） | する |
| `sleep_duration_min` | 正当な値の可能性あり | しない |
| `sleep_deep_min` | 正当な値（深い睡眠が検出されない場合） | しない |

### 決定3: 最小ベースラインカウント閾値の導入

`MIN_BASELINE_COUNT = 7` を新設。ゼロフィルタ後に有効データが7日未満のメトリクスはベースラインを `None` とし、VRI から自動除外する。

- 1〜2日のデータから算出した中央値/MAD は統計的に不安定
- 7日は保守的な閾値であり、データ蓄積の初期段階でもメトリクスを早期に活用できる
- カウント自体は引き続き返却され（例: `br_count: 1`）、除外理由の可視化が可能

### 決定4: CSV からの安静時心拍数の欠損補完

過去データの `resting_hr = 0`（欠損）を外部エクスポートの実測値で補完した。

- 条件付き UPDATE: `resting_hr = 0 OR resting_hr IS NULL` の行のみ更新
- 既存のデバイスデータ（`resting_hr > 0`）は一切上書きしない
- マイグレーションファイルではなくワンショット SQL として実行（再現性不要の一回限りの補完）

## RESULTS, EFFECTS

### PROS

- **正確なベースライン**: ゼロセンチネルが除外され、実データのみから中央値/MAD が計算される
- **無意味なメトリクスの自動除外**: データ不足のメトリクスが VRI に含まれなくなり、スコアの信頼性が向上
- **コードベース全体の一貫性**: Go API / anomaly_quality / hrv_features で既に確立されていた `0 = missing` パターンを zscore.py にも適用
- **後方互換性**: `_extract_valid()` の `exclude_zero` パラメータはデフォルト `False` であり、既存の呼び出し元に影響しない
- **安静時心拍数の補完**: 40日分の欠損が埋まり、resting_hr のベースライン精度が向上

### CONS, TRADEOFF

- **BR メトリクスの一時的な除外**: 非ゼロの呼吸数データが7日分蓄積されるまで、BR は VRI から除外される。これは正しい動作だが、VRI の構成メトリクス数が減少し confidence が下がる
- **ワンショット SQL の非再現性**: CSV インポートはマイグレーションに含めなかったため、DB を再構築した場合は手動での再実行が必要

## APPENDIX

### 変更ファイル一覧

| ファイル | 変更内容 |
|---|---|
| `ml/app/features/zscore.py` | `exclude_zero` パラメータ追加、`MIN_BASELINE_COUNT` 定数追加、`_stats` 閾値チェック、センチネルメトリクスのフィルタ適用 |
| `ml/app/models/vri_scorer.py` | `_ZERO_IS_MISSING_FIELDS` セット追加、当日値のゼロセンチネルフィルタ |
| `ml/tests/test_zscore.py` | `exclude_zero` 関連テスト5件追加 |
| `ml/tests/test_vri_scorer.py` | ゼロ値・ベースラインカウント関連テスト7件追加 |

### 検証結果

- 全52テスト（zscore + vri_scorer）パス
- CSV インポート: 39行更新（105 → 144行が resting_hr > 0）
